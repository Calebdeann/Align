<!DOCTYPE html>
<html>
<head>
  <title>Exercise Bin Tool</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
    h1 { color: #947AFF; font-size: 22px; margin-bottom: 4px; }
    .subtitle { color: #666; font-size: 13px; margin-bottom: 16px; }
    .progress-bar-wrap { width: 100%; max-width: 600px; height: 6px; background: #1a1a1a; border-radius: 3px; margin-bottom: 8px; overflow: hidden; }
    .progress-bar { height: 100%; background: #947AFF; border-radius: 3px; transition: width 0.3s; }
    .progress-text { font-size: 13px; color: #888; margin-bottom: 20px; }
    .card { width: 100%; max-width: 600px; background: #111; border: 1px solid #222; border-radius: 16px; padding: 24px; display: flex; flex-direction: column; align-items: center; gap: 16px; min-height: 400px; }
    .card.binned-card { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.05); }
    .card.kept-card { border-color: rgba(34,197,94,0.4); background: rgba(34,197,94,0.05); }
    .thumb-area { position: relative; width: 200px; height: 200px; border-radius: 12px; overflow: hidden; background: #1a1a1a; cursor: pointer; border: 2px solid #222; }
    .thumb-area img { width: 100%; height: 100%; object-fit: cover; }
    .thumb-area .no-img { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: #555; font-size: 14px; }
    .thumb-area:hover { border-color: #947AFF; }
    .exercise-name { font-size: 22px; font-weight: 700; color: #fff; text-align: center; }
    .exercise-meta { display: flex; gap: 12px; align-items: center; }
    .meta-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .meta-muscle { background: #1a1a3e; color: #947AFF; }
    .meta-equip { background: #1a2a1a; color: #4ade80; }
    .exercise-original { color: #555; font-size: 12px; font-style: italic; }
    .actions { display: flex; gap: 16px; margin-top: 8px; }
    .action-btn { width: 140px; height: 56px; border-radius: 12px; border: 2px solid #333; background: #1a1a1a; color: #ccc; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .action-btn:hover { transform: scale(1.05); }
    .btn-keep { border-color: #22c55e; color: #22c55e; }
    .btn-keep:hover, .btn-keep.flash { background: #22c55e; color: white; }
    .btn-bin { border-color: #ef4444; color: #ef4444; }
    .btn-bin:hover, .btn-bin.flash { background: #ef4444; color: white; }
    .btn-undo { border-color: #666; color: #888; width: 56px; }
    .btn-undo:hover { background: #333; color: white; }
    .key-hint { font-size: 11px; color: #555; padding: 2px 6px; border: 1px solid #333; border-radius: 4px; font-family: monospace; }
    .nav-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .stats-bar { display: flex; gap: 20px; margin-bottom: 16px; }
    .stat { text-align: center; }
    .stat-val { font-size: 20px; font-weight: 700; }
    .stat-val.keep-color { color: #22c55e; }
    .stat-val.bin-color { color: #ef4444; }
    .stat-val.todo-color { color: #888; }
    .stat-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .gif-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 60; display: none; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px; }
    .gif-overlay img { max-width: 400px; max-height: 400px; border-radius: 12px; border: 2px solid #947AFF; }
    .gif-overlay .gif-label { color: white; font-size: 16px; font-weight: 600; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 8px; }
    .filter-row { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-btn { padding: 5px 12px; border-radius: 20px; border: 1px solid #333; background: #1a1a1a; color: #ccc; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .filter-btn:hover { border-color: #947AFF; color: #947AFF; }
    .filter-btn.active { background: #947AFF; border-color: #947AFF; color: white; }
    .done-screen { text-align: center; padding: 40px; }
    .done-screen h2 { color: #947AFF; font-size: 28px; margin-bottom: 12px; }
    .done-screen p { color: #888; margin-bottom: 20px; }
    .btn { padding: 10px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #947AFF; color: white; }
    .btn-primary:hover { background: #7c5fff; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #333; color: #ccc; }
    .btn-secondary:hover { background: #444; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; background: #22c55e; color: white; font-weight: 600; z-index: 100; display: none; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; display: none; align-items: center; justify-content: center; }
    .modal { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal h2 { color: #947AFF; margin-bottom: 12px; }
    .modal pre { background: #0a0a0a; border: 1px solid #333; border-radius: 8px; padding: 16px; overflow-x: auto; font-size: 13px; color: #e0e0e0; white-space: pre-wrap; word-break: break-all; }
    .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid #333; border-top-color: #947AFF; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .review-toggle { display: flex; gap: 4px; background: #1a1a1a; border-radius: 8px; padding: 3px; border: 1px solid #222; margin-bottom: 16px; }
    .review-toggle button { padding: 6px 16px; border: none; border-radius: 6px; background: transparent; color: #888; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .review-toggle button.active { background: #947AFF; color: white; }
  </style>
</head>
<body>
  <h1>Exercise Bin Tool</h1>
  <p class="subtitle">Press <b>A</b> to keep, <b>B</b> to bin. Click thumbnail for GIF. Arrow keys to navigate.</p>

  <div class="stats-bar">
    <div class="stat"><div class="stat-val keep-color" id="stat-keep">0</div><div class="stat-label">Keep</div></div>
    <div class="stat"><div class="stat-val bin-color" id="stat-bin">0</div><div class="stat-label">Bin</div></div>
    <div class="stat"><div class="stat-val todo-color" id="stat-todo">0</div><div class="stat-label">Remaining</div></div>
  </div>

  <div class="progress-bar-wrap"><div class="progress-bar" id="progress-bar"></div></div>
  <div class="progress-text" id="progress-text">Loading...</div>

  <div class="review-toggle" id="review-toggle">
    <button class="active" onclick="setViewMode('unreviewed')">Unreviewed</button>
    <button onclick="setViewMode('all')">All</button>
    <button onclick="setViewMode('binned')">Binned</button>
    <button onclick="setViewMode('kept')">Kept</button>
  </div>

  <div class="filter-row" id="filters"></div>

  <div id="loading" class="loading"><span class="loading-spinner"></span> Loading exercises from Supabase...</div>

  <div class="card" id="card" style="display:none">
    <div class="thumb-area" id="thumb-area" onclick="showGif()">
      <img id="thumb-img" src="" />
      <div class="no-img" id="no-img" style="display:none">No image</div>
    </div>
    <div class="exercise-name" id="ex-name">-</div>
    <div class="exercise-meta">
      <span class="meta-badge meta-muscle" id="ex-muscle">-</span>
      <span class="meta-badge meta-equip" id="ex-equip">-</span>
    </div>
    <div class="exercise-original" id="ex-original">-</div>
    <div class="actions">
      <button class="action-btn btn-undo" id="btn-undo" onclick="goBack()" title="Go back">&#8592;</button>
      <button class="action-btn btn-keep" id="btn-keep" onclick="decide('keep')">
        Keep <span class="key-hint">A</span>
      </button>
      <button class="action-btn btn-bin" id="btn-bin" onclick="decide('bin')">
        Bin <span class="key-hint">B</span>
      </button>
    </div>
  </div>

  <div class="done-screen" id="done-screen" style="display:none">
    <h2>All reviewed!</h2>
    <p id="done-summary">-</p>
    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="exportBinned()">Export Binned JSON</button>
      <button class="btn btn-danger" onclick="deleteBinned()">Delete Binned from Supabase</button>
      <button class="btn btn-secondary" onclick="resetAll()">Start Over</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="gif-overlay" id="gif-overlay" onclick="closeGif()">
    <img id="gif-img" src="" />
    <div class="gif-label" id="gif-label"></div>
  </div>

  <div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal" onclick="event.stopPropagation()">
      <h2 id="modal-title">Export</h2>
      <pre id="modal-content"></pre>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="navigator.clipboard.writeText(document.getElementById('modal-content').textContent);showToast('Copied!')">Copy to Clipboard</button>
        <button class="btn btn-secondary" onclick="document.getElementById('modal-overlay').style.display='none'">Close</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dngpsabyqsuunajtotci.supabase.co';
    const ANON_KEY = 'sb_publishable_LXI8w9s0XF_r1LI3u7LpAg_IM4KGa63';
    const STORAGE_KEY = 'bin-tool-decisions';

    let allExercises = [];
    let filteredList = [];
    let currentIndex = 0;
    let decisions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    let viewMode = 'unreviewed';
    let activeCategory = 'All';

    async function fetchExercises() {
      const all = [];
      let offset = 0;
      while (true) {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/exercises?select=id,name,display_name,muscle_group,equipment,thumbnail_url,image_url&order=name&offset=${offset}&limit=1000`, {
          headers: { 'apikey': ANON_KEY, 'Authorization': `Bearer ${ANON_KEY}` }
        });
        const data = await resp.json();
        all.push(...data);
        if (data.length < 1000) break;
        offset += 1000;
      }
      return all.sort((a, b) => {
        const na = (a.display_name || a.name).toLowerCase();
        const nb = (b.display_name || b.name).toLowerCase();
        return na.localeCompare(nb);
      });
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(decisions));
    }

    function getCategory(muscle) {
      if (!muscle) return 'Other';
      const m = muscle.toLowerCase();
      if (m.includes('glute') || m.includes('quad') || m.includes('hamstring') || m.includes('adductor') || m.includes('abductor') || m.includes('calve')) return 'Legs/Glutes';
      if (m.includes('lat') || m.includes('upper back') || m.includes('spine') || m.includes('trap')) return 'Back';
      if (m.includes('pectoral') || m.includes('chest')) return 'Chest';
      if (m.includes('delt') || m.includes('shoulder') || m.includes('serratus')) return 'Shoulders';
      if (m.includes('bicep')) return 'Biceps';
      if (m.includes('tricep')) return 'Triceps';
      if (m.includes('abs') || m.includes('core')) return 'Core';
      if (m.includes('cardio')) return 'Cardio';
      if (m.includes('forearm')) return 'Forearms';
      return 'Other';
    }

    function buildFilteredList() {
      let list = allExercises;
      if (activeCategory !== 'All') {
        list = list.filter(e => getCategory(e.muscle_group) === activeCategory);
      }
      if (viewMode === 'unreviewed') {
        filteredList = list.filter(e => !decisions[e.id]);
      } else if (viewMode === 'binned') {
        filteredList = list.filter(e => decisions[e.id] === 'bin');
      } else if (viewMode === 'kept') {
        filteredList = list.filter(e => decisions[e.id] === 'keep');
      } else {
        filteredList = list;
      }
      currentIndex = Math.min(currentIndex, Math.max(0, filteredList.length - 1));
    }

    function updateStats() {
      const kept = Object.values(decisions).filter(d => d === 'keep').length;
      const binned = Object.values(decisions).filter(d => d === 'bin').length;
      const remaining = allExercises.length - kept - binned;
      document.getElementById('stat-keep').textContent = kept;
      document.getElementById('stat-bin').textContent = binned;
      document.getElementById('stat-todo').textContent = remaining;
      const pct = allExercises.length > 0 ? ((kept + binned) / allExercises.length * 100) : 0;
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('progress-text').textContent = `${kept + binned} / ${allExercises.length} reviewed (${Math.round(pct)}%)`;
    }

    function showExercise() {
      buildFilteredList();
      updateStats();

      if (filteredList.length === 0) {
        document.getElementById('card').style.display = 'none';
        document.getElementById('done-screen').style.display = 'block';
        const binned = Object.values(decisions).filter(d => d === 'bin').length;
        const kept = Object.values(decisions).filter(d => d === 'keep').length;
        document.getElementById('done-summary').textContent = viewMode === 'unreviewed'
          ? `${kept} kept, ${binned} binned out of ${allExercises.length} exercises.`
          : `No exercises match this filter.`;
        return;
      }

      document.getElementById('done-screen').style.display = 'none';
      document.getElementById('card').style.display = 'flex';

      const ex = filteredList[currentIndex];
      const dec = decisions[ex.id];
      const card = document.getElementById('card');
      card.className = 'card' + (dec === 'bin' ? ' binned-card' : dec === 'keep' ? ' kept-card' : '');

      document.getElementById('ex-name').textContent = ex.display_name || ex.name;
      document.getElementById('ex-muscle').textContent = getCategory(ex.muscle_group);
      document.getElementById('ex-equip').textContent = (ex.equipment || []).join(', ') || 'body weight';
      document.getElementById('ex-original').textContent = ex.name !== ex.display_name ? `DB name: ${ex.name}` : '';

      const img = document.getElementById('thumb-img');
      const noImg = document.getElementById('no-img');
      if (ex.thumbnail_url) {
        img.src = ex.thumbnail_url;
        img.style.display = 'block';
        noImg.style.display = 'none';
        img.onerror = () => { img.style.display = 'none'; noImg.style.display = 'flex'; };
      } else {
        img.style.display = 'none';
        noImg.style.display = 'flex';
      }
    }

    function decide(action) {
      if (filteredList.length === 0) return;
      const ex = filteredList[currentIndex];
      decisions[ex.id] = action;
      save();

      // Flash the button
      const btn = action === 'keep' ? document.getElementById('btn-keep') : document.getElementById('btn-bin');
      btn.classList.add('flash');
      setTimeout(() => btn.classList.remove('flash'), 150);

      if (viewMode === 'unreviewed') {
        buildFilteredList();
        if (currentIndex >= filteredList.length) currentIndex = Math.max(0, filteredList.length - 1);
      } else {
        if (currentIndex < filteredList.length - 1) currentIndex++;
      }
      showExercise();
    }

    function goBack() {
      if (viewMode === 'unreviewed') {
        // Can't go back easily in unreviewed mode, undo last decision instead
        const allIds = allExercises.map(e => e.id);
        const decidedIds = allIds.filter(id => decisions[id]);
        if (decidedIds.length > 0) {
          const lastId = decidedIds[decidedIds.length - 1];
          delete decisions[lastId];
          save();
          buildFilteredList();
          // Jump to the exercise we just undid
          const idx = filteredList.findIndex(e => e.id === lastId);
          if (idx >= 0) currentIndex = idx;
          showExercise();
        }
      } else {
        if (currentIndex > 0) {
          currentIndex--;
          showExercise();
        }
      }
    }

    function setViewMode(mode) {
      viewMode = mode;
      currentIndex = 0;
      document.querySelectorAll('.review-toggle button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.review-toggle button').forEach(b => {
        if (b.textContent.toLowerCase().includes(mode === 'all' ? 'all' : mode)) b.classList.add('active');
      });
      showExercise();
    }

    function setCategory(cat, btn) {
      activeCategory = cat;
      currentIndex = 0;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      showExercise();
    }

    function buildFilters() {
      const cats = ['All', ...new Set(allExercises.map(e => getCategory(e.muscle_group)))].filter(Boolean);
      const div = document.getElementById('filters');
      cats.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (cat === 'All' ? ' active' : '');
        const count = cat === 'All' ? allExercises.length : allExercises.filter(e => getCategory(e.muscle_group) === cat).length;
        btn.textContent = `${cat} (${count})`;
        btn.onclick = function() { setCategory(cat, this); };
        div.appendChild(btn);
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'a' || e.key === 'A') { e.preventDefault(); decide('keep'); }
      if (e.key === 'b' || e.key === 'B') { e.preventDefault(); decide('bin'); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); goBack(); }
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        if (currentIndex < filteredList.length - 1) { currentIndex++; showExercise(); }
      }
    });

    window.showGif = function() {
      const ex = filteredList[currentIndex];
      if (!ex?.image_url) return;
      document.getElementById('gif-img').src = ex.image_url;
      document.getElementById('gif-label').textContent = ex.display_name || ex.name;
      document.getElementById('gif-overlay').style.display = 'flex';
    };

    window.closeGif = function() {
      document.getElementById('gif-overlay').style.display = 'none';
      document.getElementById('gif-img').src = '';
    };

    window.exportBinned = function() {
      const binned = allExercises.filter(e => decisions[e.id] === 'bin').map(e => ({
        id: e.id,
        name: e.name,
        display_name: e.display_name,
        status: 'binned'
      }));
      document.getElementById('modal-title').textContent = `Binned Exercises (${binned.length})`;
      document.getElementById('modal-content').textContent = JSON.stringify(binned, null, 2);
      document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.deleteBinned = async function() {
      const binnedExercises = allExercises.filter(e => decisions[e.id] === 'bin');
      if (binnedExercises.length === 0) { showToast('Nothing to delete'); return; }
      if (!confirm(`Delete ${binnedExercises.length} exercises from Supabase?`)) return;
      const serviceKey = prompt('Enter your SUPABASE_SERVICE_ROLE_KEY:');
      if (!serviceKey) return;

      const ids = binnedExercises.map(e => e.id);
      const headers = { 'apikey': serviceKey, 'Authorization': `Bearer ${serviceKey}`, 'Prefer': 'return=minimal' };
      let success = 0, failed = 0;

      for (let i = 0; i < ids.length; i += 20) {
        const batch = ids.slice(i, i + 20);
        const filter = batch.map(id => `"${id}"`).join(',');
        try {
          const resp = await fetch(`${SUPABASE_URL}/rest/v1/exercises?id=in.(${filter})`, { method: 'DELETE', headers });
          if (resp.ok) success += batch.length; else failed += batch.length;
        } catch { failed += batch.length; }
      }

      showToast(`Deleted ${success} exercises. ${failed ? failed + ' failed.' : ''}`);
      if (success > 0) {
        allExercises = allExercises.filter(e => decisions[e.id] !== 'bin');
        Object.keys(decisions).forEach(id => { if (decisions[id] === 'bin') delete decisions[id]; });
        save();
        buildFilteredList();
        showExercise();
      }
    };

    window.resetAll = function() {
      if (!confirm('Clear all decisions? This cannot be undone.')) return;
      decisions = {};
      save();
      currentIndex = 0;
      showExercise();
    };

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 2500);
    }

    async function init() {
      allExercises = await fetchExercises();
      document.getElementById('loading').style.display = 'none';
      buildFilters();
      showExercise();
    }

    init();
  </script>
</body>
</html>
