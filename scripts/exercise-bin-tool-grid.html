<!DOCTYPE html>
<html>
<head>
  <title>Exercise Bin Tool - Grid</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; padding: 20px; }
    .header { text-align: center; margin-bottom: 20px; }
    h1 { color: #947AFF; font-size: 22px; margin-bottom: 4px; }
    .subtitle { color: #666; font-size: 13px; margin-bottom: 16px; }
    .stats-bar { display: flex; gap: 24px; justify-content: center; margin-bottom: 12px; }
    .stat { text-align: center; }
    .stat-val { font-size: 22px; font-weight: 700; }
    .stat-val.keep-color { color: #22c55e; }
    .stat-val.bin-color { color: #ef4444; }
    .stat-val.total-color { color: #888; }
    .stat-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .progress-bar-wrap { max-width: 600px; margin: 0 auto 8px; height: 6px; background: #1a1a1a; border-radius: 3px; overflow: hidden; }
    .progress-bar { height: 100%; background: #947AFF; border-radius: 3px; transition: width 0.3s; }
    .progress-text { font-size: 12px; color: #666; text-align: center; margin-bottom: 16px; }
    .controls { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 12px; }
    .filter-btn { padding: 5px 12px; border-radius: 20px; border: 1px solid #333; background: #1a1a1a; color: #ccc; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .filter-btn:hover { border-color: #947AFF; color: #947AFF; }
    .filter-btn.active { background: #947AFF; border-color: #947AFF; color: white; }
    .view-toggle { display: flex; gap: 4px; background: #1a1a1a; border-radius: 8px; padding: 3px; border: 1px solid #222; justify-content: center; margin-bottom: 16px; }
    .view-toggle button { padding: 6px 16px; border: none; border-radius: 6px; background: transparent; color: #888; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .view-toggle button.active { background: #947AFF; color: white; }
    .action-bar { display: flex; gap: 8px; justify-content: center; margin-bottom: 16px; }
    .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #947AFF; color: white; }
    .btn-primary:hover { background: #7c5fff; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #222; color: #ccc; border: 1px solid #333; }
    .btn-secondary:hover { background: #333; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; max-width: 1400px; margin: 0 auto; }
    .card { background: #111; border: 1px solid #222; border-radius: 12px; overflow: hidden; transition: all 0.2s; position: relative; }
    .card:hover { border-color: #444; }
    .card.binned { border-color: rgba(239,68,68,0.5); opacity: 0.45; }
    .card.binned .card-thumb { filter: grayscale(1); }
    .card-thumb { width: 100%; aspect-ratio: 1; background: #1a1a1a; cursor: pointer; position: relative; overflow: hidden; }
    .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .card-thumb .no-img { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: #444; font-size: 12px; }
    .card-body { padding: 8px 10px 10px; }
    .card-name { font-size: 12px; font-weight: 600; color: #e0e0e0; margin-bottom: 4px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-meta { font-size: 10px; color: #666; margin-bottom: 8px; }
    .card-actions { display: flex; gap: 6px; }
    .card-btn { flex: 1; padding: 6px 0; border-radius: 6px; border: 1px solid #333; background: #1a1a1a; color: #ccc; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.15s; text-align: center; }
    .card-btn:hover { transform: scale(1.03); }
    .card-btn.btn-bin { border-color: #ef4444; color: #ef4444; }
    .card-btn.btn-bin:hover { background: #ef4444; color: white; }
    .card-btn.btn-undo { border-color: #22c55e; color: #22c55e; }
    .card-btn.btn-undo:hover { background: #22c55e; color: white; }
    .binned-badge { position: absolute; top: 6px; right: 6px; background: #ef4444; color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; z-index: 2; }
    .gif-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 60; display: none; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px; }
    .gif-overlay img { max-width: 400px; max-height: 400px; border-radius: 12px; border: 2px solid #947AFF; }
    .gif-overlay .gif-label { color: white; font-size: 16px; font-weight: 600; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 8px; }
    .loading { text-align: center; padding: 60px; color: #888; }
    .loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid #333; border-top-color: #947AFF; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; background: #22c55e; color: white; font-weight: 600; z-index: 100; display: none; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; display: none; align-items: center; justify-content: center; }
    .modal { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal h2 { color: #947AFF; margin-bottom: 12px; }
    .modal pre { background: #0a0a0a; border: 1px solid #333; border-radius: 8px; padding: 16px; overflow-x: auto; font-size: 13px; color: #e0e0e0; white-space: pre-wrap; word-break: break-all; }
    .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    .empty-state h3 { color: #947AFF; margin-bottom: 8px; }
    .search-wrap { max-width: 400px; margin: 0 auto 16px; }
    .search-input { width: 100%; padding: 8px 14px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; font-size: 14px; outline: none; }
    .search-input:focus { border-color: #947AFF; }
    .search-input::placeholder { color: #555; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Exercise Bin Tool</h1>
    <p class="subtitle">Click thumbnails for GIF preview. Click Bin to remove exercises.</p>
  </div>

  <div class="stats-bar">
    <div class="stat"><div class="stat-val keep-color" id="stat-keep">0</div><div class="stat-label">Keep</div></div>
    <div class="stat"><div class="stat-val bin-color" id="stat-bin">0</div><div class="stat-label">Binned</div></div>
    <div class="stat"><div class="stat-val total-color" id="stat-total">0</div><div class="stat-label">Total</div></div>
  </div>

  <div class="progress-bar-wrap"><div class="progress-bar" id="progress-bar"></div></div>
  <div class="progress-text" id="progress-text">Loading...</div>

  <div class="search-wrap">
    <input type="text" class="search-input" id="search-input" placeholder="Search exercises..." oninput="onSearch()" />
  </div>

  <div class="view-toggle" id="view-toggle">
    <button class="active" onclick="setViewMode('all')">All</button>
    <button onclick="setViewMode('kept')">Kept</button>
    <button onclick="setViewMode('binned')">Binned</button>
  </div>

  <div class="controls" id="filters"></div>

  <div class="action-bar">
    <button class="btn btn-primary" onclick="exportBinned()">Export Binned JSON</button>
    <button class="btn btn-danger" onclick="deleteBinned()">Delete Binned from Supabase</button>
    <button class="btn btn-secondary" onclick="resetAll()">Reset All</button>
  </div>

  <div id="loading" class="loading"><span class="loading-spinner"></span> Loading exercises from Supabase...</div>

  <div class="grid" id="grid"></div>

  <div class="empty-state" id="empty-state" style="display:none">
    <h3>No exercises match</h3>
    <p>Try a different filter or view mode.</p>
  </div>

  <div class="toast" id="toast"></div>

  <div class="gif-overlay" id="gif-overlay" onclick="closeGif()">
    <img id="gif-img" src="" />
    <div class="gif-label" id="gif-label"></div>
  </div>

  <div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal" onclick="event.stopPropagation()">
      <h2 id="modal-title">Export</h2>
      <pre id="modal-content"></pre>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="navigator.clipboard.writeText(document.getElementById('modal-content').textContent);showToast('Copied!')">Copy to Clipboard</button>
        <button class="btn btn-secondary" onclick="document.getElementById('modal-overlay').style.display='none'">Close</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dngpsabyqsuunajtotci.supabase.co';
    const ANON_KEY = 'sb_publishable_LXI8w9s0XF_r1LI3u7LpAg_IM4KGa63';
    const STORAGE_KEY = 'bin-tool-grid-decisions';

    let allExercises = [];
    let decisions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    let viewMode = 'all';
    let activeCategory = 'All';
    let searchQuery = '';

    async function fetchExercises() {
      const all = [];
      let offset = 0;
      while (true) {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/exercises?select=id,name,display_name,muscle_group,equipment,thumbnail_url,image_url&order=name&offset=${offset}&limit=1000`, {
          headers: { 'apikey': ANON_KEY, 'Authorization': `Bearer ${ANON_KEY}` }
        });
        const data = await resp.json();
        all.push(...data);
        if (data.length < 1000) break;
        offset += 1000;
      }
      return all.sort((a, b) => {
        const na = (a.display_name || a.name).toLowerCase();
        const nb = (b.display_name || b.name).toLowerCase();
        return na.localeCompare(nb);
      });
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(decisions));
    }

    function getCategory(muscle) {
      if (!muscle) return 'Other';
      const m = muscle.toLowerCase();
      if (m.includes('glute') || m.includes('quad') || m.includes('hamstring') || m.includes('adductor') || m.includes('abductor') || m.includes('calve')) return 'Legs/Glutes';
      if (m.includes('lat') || m.includes('upper back') || m.includes('spine') || m.includes('trap')) return 'Back';
      if (m.includes('pectoral') || m.includes('chest')) return 'Chest';
      if (m.includes('delt') || m.includes('shoulder') || m.includes('serratus')) return 'Shoulders';
      if (m.includes('bicep')) return 'Biceps';
      if (m.includes('tricep')) return 'Triceps';
      if (m.includes('abs') || m.includes('core')) return 'Core';
      if (m.includes('cardio')) return 'Cardio';
      if (m.includes('forearm')) return 'Forearms';
      return 'Other';
    }

    function getFilteredExercises() {
      let list = allExercises;

      if (activeCategory !== 'All') {
        list = list.filter(e => getCategory(e.muscle_group) === activeCategory);
      }

      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        list = list.filter(e => {
          const name = (e.display_name || e.name).toLowerCase();
          return name.includes(q);
        });
      }

      if (viewMode === 'binned') {
        list = list.filter(e => decisions[e.id] === 'bin');
      } else if (viewMode === 'kept') {
        list = list.filter(e => decisions[e.id] !== 'bin');
      }

      return list;
    }

    function updateStats() {
      const binned = Object.values(decisions).filter(d => d === 'bin').length;
      const kept = allExercises.length - binned;
      document.getElementById('stat-keep').textContent = kept;
      document.getElementById('stat-bin').textContent = binned;
      document.getElementById('stat-total').textContent = allExercises.length;
      const pct = allExercises.length > 0 ? (binned / allExercises.length * 100) : 0;
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('progress-text').textContent = `${binned} binned out of ${allExercises.length} exercises`;
    }

    function renderGrid() {
      const filtered = getFilteredExercises();
      const grid = document.getElementById('grid');
      const emptyState = document.getElementById('empty-state');

      if (filtered.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      grid.innerHTML = filtered.map(ex => {
        const isBinned = decisions[ex.id] === 'bin';
        const name = ex.display_name || ex.name;
        const cat = getCategory(ex.muscle_group);
        const equip = (ex.equipment || []).join(', ') || 'body weight';

        return `
          <div class="card ${isBinned ? 'binned' : ''}" id="card-${ex.id}">
            ${isBinned ? '<div class="binned-badge">BINNED</div>' : ''}
            <div class="card-thumb" onclick="showGif('${ex.id}')">
              ${ex.thumbnail_url
                ? `<img src="${ex.thumbnail_url}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" /><div class="no-img" style="display:none">No image</div>`
                : `<div class="no-img">No image</div>`
              }
            </div>
            <div class="card-body">
              <div class="card-name" title="${name}">${name}</div>
              <div class="card-meta">${cat} &middot; ${equip}</div>
              <div class="card-actions">
                ${isBinned
                  ? `<button class="card-btn btn-undo" onclick="undoBin('${ex.id}')">Undo</button>`
                  : `<button class="card-btn btn-bin" onclick="binExercise('${ex.id}')">Bin</button>`
                }
              </div>
            </div>
          </div>
        `;
      }).join('');

      updateStats();
    }

    function binExercise(id) {
      decisions[id] = 'bin';
      save();

      const card = document.getElementById('card-' + id);
      if (card) {
        card.classList.add('binned');

        // Update card content in place for speed
        const badge = document.createElement('div');
        badge.className = 'binned-badge';
        badge.textContent = 'BINNED';
        card.prepend(badge);

        const actionsDiv = card.querySelector('.card-actions');
        actionsDiv.innerHTML = `<button class="card-btn btn-undo" onclick="undoBin('${id}')">Undo</button>`;

        // Add grayscale to thumb
        const thumb = card.querySelector('.card-thumb img');
        if (thumb) thumb.style.filter = 'grayscale(1)';
      }

      updateStats();
    }

    function undoBin(id) {
      delete decisions[id];
      save();

      const card = document.getElementById('card-' + id);
      if (card) {
        card.classList.remove('binned');

        const badge = card.querySelector('.binned-badge');
        if (badge) badge.remove();

        const actionsDiv = card.querySelector('.card-actions');
        actionsDiv.innerHTML = `<button class="card-btn btn-bin" onclick="binExercise('${id}')">Bin</button>`;

        const thumb = card.querySelector('.card-thumb img');
        if (thumb) thumb.style.filter = '';
      }

      updateStats();
    }

    function showGif(id) {
      const ex = allExercises.find(e => e.id === id);
      if (!ex?.image_url) return;
      document.getElementById('gif-img').src = ex.image_url;
      document.getElementById('gif-label').textContent = ex.display_name || ex.name;
      document.getElementById('gif-overlay').style.display = 'flex';
    }

    function closeGif() {
      document.getElementById('gif-overlay').style.display = 'none';
      document.getElementById('gif-img').src = '';
    }

    function setViewMode(mode) {
      viewMode = mode;
      document.querySelectorAll('#view-toggle button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#view-toggle button').forEach(b => {
        if (b.textContent.toLowerCase() === mode) b.classList.add('active');
      });
      renderGrid();
    }

    function setCategory(cat, btn) {
      activeCategory = cat;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderGrid();
    }

    function onSearch() {
      searchQuery = document.getElementById('search-input').value.trim();
      renderGrid();
    }

    function buildFilters() {
      const cats = ['All', ...new Set(allExercises.map(e => getCategory(e.muscle_group)))].filter(Boolean);
      const div = document.getElementById('filters');
      cats.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (cat === 'All' ? ' active' : '');
        const count = cat === 'All' ? allExercises.length : allExercises.filter(e => getCategory(e.muscle_group) === cat).length;
        btn.textContent = `${cat} (${count})`;
        btn.onclick = function() { setCategory(cat, this); };
        div.appendChild(btn);
      });
    }

    function exportBinned() {
      const binned = allExercises.filter(e => decisions[e.id] === 'bin').map(e => ({
        id: e.id,
        name: e.name,
        display_name: e.display_name
      }));
      if (binned.length === 0) { showToast('Nothing binned yet'); return; }
      document.getElementById('modal-title').textContent = `Binned Exercises (${binned.length})`;
      document.getElementById('modal-content').textContent = JSON.stringify(binned, null, 2);
      document.getElementById('modal-overlay').style.display = 'flex';
    }

    async function deleteBinned() {
      const binnedExercises = allExercises.filter(e => decisions[e.id] === 'bin');
      if (binnedExercises.length === 0) { showToast('Nothing to delete'); return; }
      if (!confirm(`Delete ${binnedExercises.length} exercises from Supabase? This cannot be undone.`)) return;
      const serviceKey = prompt('Enter your SUPABASE_SERVICE_ROLE_KEY:');
      if (!serviceKey) return;

      const ids = binnedExercises.map(e => e.id);
      const headers = { 'apikey': serviceKey, 'Authorization': `Bearer ${serviceKey}`, 'Prefer': 'return=minimal' };
      let success = 0, failed = 0;

      for (let i = 0; i < ids.length; i += 20) {
        const batch = ids.slice(i, i + 20);
        const filter = batch.map(id => `"${id}"`).join(',');
        try {
          const resp = await fetch(`${SUPABASE_URL}/rest/v1/exercises?id=in.(${filter})`, { method: 'DELETE', headers });
          if (resp.ok) success += batch.length; else failed += batch.length;
        } catch { failed += batch.length; }
      }

      showToast(`Deleted ${success} exercises. ${failed ? failed + ' failed.' : ''}`);
      if (success > 0) {
        allExercises = allExercises.filter(e => decisions[e.id] !== 'bin');
        Object.keys(decisions).forEach(id => { if (decisions[id] === 'bin') delete decisions[id]; });
        save();
        renderGrid();
      }
    }

    function resetAll() {
      if (!confirm('Clear all bin decisions? This cannot be undone.')) return;
      decisions = {};
      save();
      renderGrid();
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 2500);
    }

    // Escape closes GIF overlay
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeGif();
    });

    async function init() {
      allExercises = await fetchExercises();
      document.getElementById('loading').style.display = 'none';
      buildFilters();
      renderGrid();
    }

    init();
  </script>
</body>
</html>
